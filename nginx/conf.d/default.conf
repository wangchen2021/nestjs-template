# 关闭Nginx版本暴露（安全规范）
server_tokens off;

# 80端口重定向到443
server {
    listen 80;
    server_name nestjs.duguqinchen.com;
    charset utf-8;
    return 301 https://$host$request_uri;
}

# 443端口HTTPS配置
server {
    listen 443 ssl;
    # 开启HTTP/2
    http2 on;
    server_name nestjs.duguqinchen.com;

    # HTTPS证书（容器内路径，对应挂载的目录）
    ssl_certificate  /etc/nginx/cert/nestjs.duguqinchen.com_bundle.crt;
    ssl_certificate_key /etc/nginx/cert/nestjs.duguqinchen.com.key;

    # 安全协议/加密套件（保留）
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;
    # 优化：开启会话复用，提升HTTPS性能
    ssl_session_cache shared:SSL:10m;

    # 前端路由（若有前端静态文件，需挂载前端目录，否则注释）
    # root /www/wwwroot/version_web;
    # index index.html index.htm;
    # location / {
    #     try_files $uri $uri/ /index.html;
    # }

    # 静态资源缓存（若有前端，保留；无则注释）
    # location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    #     expires 30d;
    #     add_header Cache-Control "public, max-age=2592000";
    # }

    # 禁止隐藏文件
    location ~ /\. {
        deny all;
    }
    
    # /proApi 代理配置（核心修复）
    location /proApi/ {
        # 修复：去掉末尾/，保留/proApi前缀
        proxy_pass http://nestjs-backend:30001/proApi;
        
        # 代理头信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 优化：添加HTTP/1.1协议和长连接配置
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 超时/缓冲区配置（保留）
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 28k;
        proxy_temp_file_write_size 16k;
    }
}