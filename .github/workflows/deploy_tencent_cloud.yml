name: NestJS Backend Auto Deploy to Tencent Cloud (Docker)
run-name: ${{ github.actor }} éƒ¨ç½²NestJSåç«¯ ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          # - test

env:
  SERVER_PROJECT_DIR: "/usr/local/project/nestjs-template/${{ github.event.inputs.deploy_env || 'production' }}"
  NGINX_CONF_DIR: "nginx/conf.d"
  SSH_TIMEOUT: 300s

jobs:
  Deploy-to-Tencent-Cloud-Docker:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ['24.11.0']
    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Generate build info file
        id: build_info
        run: |
          CORE_VERSION="unknown"
          FULL_VERSION="unknown-${{ github.event.inputs.deploy_env || 'prod' }}+unknown"
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          BUILD_TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "unknown")
          BUILD_TIME_TAG=$(TZ=Asia/Shanghai date +%Y%m%d%H%M%S 2>/dev/null || echo "unknown")

          if [ -n "${{ github.ref_name }}" ]; then
            CORE_VERSION="${{ github.ref_name }}"
          else
            TAG_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            CORE_VERSION=${TAG_VERSION:-$COMMIT_HASH}
          fi
          
          FULL_VERSION="${{ github.event.inputs.deploy_env || 'prod' }}-${CORE_VERSION}-${BUILD_TIME_TAG}-${COMMIT_HASH}"
          
          mkdir -p ./src/config
          cat > ./src/config/build-info.json << EOF
          {
            "coreVersion": "${CORE_VERSION}",
            "env": "${{ github.event.inputs.deploy_env || 'production' }}",
            "commitHash": "${COMMIT_HASH}",
            "buildTime": "${BUILD_TIME}",
            "fullVersion": "${FULL_VERSION}",
            "buildId": "${{ github.run_id }}-${{ github.run_attempt }}",
            "actor": "${{ github.actor }}"
          }
          EOF
          
          cat > ./src/config/build-info.env << EOF
          BUILD_CORE_VERSION=${CORE_VERSION}
          BUILD_ENV=${{ github.event.inputs.deploy_env || 'production' }}
          BUILD_COMMIT_HASH=${COMMIT_HASH}
          BUILD_TIME=${BUILD_TIME}
          BUILD_FULL_VERSION=${FULL_VERSION}
          BUILD_ID=${{ github.run_id }}-${{ github.run_attempt }}
          EOF
          
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "core_version=${CORE_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          echo "FULL_VERSION=${FULL_VERSION}" >> $GITHUB_ENV
          echo "CORE_VERSION=${CORE_VERSION}" >> $GITHUB_ENV
          
          echo "===== æ„å»ºç‰ˆæœ¬ä¿¡æ¯ ====="
          echo "Full Version: ${FULL_VERSION}"
          echo "Core Version: ${CORE_VERSION}"
          cat ./src/config/build-info.json
        env:
          NODE_ENV: ${{ github.event.inputs.deploy_env || 'production' }}
        timeout-minutes: 5

      - name: Install dependencies & Build
        run: |
          set -e
          if [ ! -f "pnpm-lock.yaml" ]; then
            echo "é”™è¯¯ï¼špnpm-lock.yamlä¸å­˜åœ¨ï¼"
            exit 1
          fi
          pnpm install --frozen-lockfile --prod=false
          pnpm run build -- --verbose
          
          echo "===== æ„å»ºäº§ç‰©æ ¡éªŒ ====="
          ls -la ./dist
          if [ ! -f "./dist/main.js" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
            exit 1
          fi
          if [ ! -f "./src/config/build-info.json" ]; then
            echo "é”™è¯¯ï¼šbuild-info.jsonæœªç”Ÿæˆï¼"
            exit 1
          fi
          cp ./src/config/build-info* ./dist/config/
          if [ ! -f "./dist/config/build-info.json" ]; then
            echo "é”™è¯¯ï¼šbuild-info.jsonæœªå¤åˆ¶åˆ°dist/configï¼"
            exit 1
          fi
        env:
          NODE_ENV: ${{ github.event.inputs.deploy_env || 'production' }}
        timeout-minutes: 10

      - name: Ensure server directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          timeout: ${{ env.SSH_TIMEOUT }}
          script: |
            set -e
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/{${{ env.NGINX_CONF_DIR }},src/config/env,src/config,dist}
            rm -rf ${{ env.SERVER_PROJECT_DIR }}/dist/* 
            rm -rf ${{ env.SERVER_PROJECT_DIR }}/node_modules/* || true
            chown -R ${{ secrets.TENCENT_SERVER_USER }}:${{ secrets.TENCENT_SERVER_USER }} ${{ env.SERVER_PROJECT_DIR }}
            chmod -R 750 ${{ env.SERVER_PROJECT_DIR }}
            echo "æœåŠ¡å™¨ç›®å½•å‡†å¤‡å®Œæˆï¼š${{ env.SERVER_PROJECT_DIR }}"

      - name: Upload config & package files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./Dockerfile,./docker-compose.yml,./${{ env.NGINX_CONF_DIR }}/default.conf,./package.json,./pnpm-lock.yaml,./src/config/env/.env*,./src/config/build-info*"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true
          timeout: ${{ env.SSH_TIMEOUT }}

      - name: Upload dist directory
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./dist"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true
          timeout: ${{ env.SSH_TIMEOUT }}

      - name: Verify files on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          timeout: ${{ env.SSH_TIMEOUT }}
          script: |
            set -e
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "===== æœåŠ¡å™¨æ–‡ä»¶æ ¡éªŒ ====="
            REQUIRED_FILES=(
              "Dockerfile"
              "docker-compose.yml"
              "dist/main.js"
              "src/config/build-info.json"
              "dist/config/build-info.json"
            )
            for FILE in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$FILE" ]; then
                echo "é”™è¯¯ï¼šæœåŠ¡å™¨ç¼ºå°‘å¿…è¦æ–‡ä»¶ $FILEï¼"
                exit 1
              fi
            done
            ls -la dist/main.js
            cat src/config/build-info.json

      - name: Build & Push Docker Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          timeout: ${{ env.SSH_TIMEOUT }}
          script: |
            set -e
            cd ${{ env.SERVER_PROJECT_DIR }}
            IMAGE_TAG="${{ steps.build_info.outputs.full_version }}"
            IMAGE_NAME="${{ secrets.DOCKER_PATH }}/nestjs-template:$IMAGE_TAG"
            LATEST_IMAGE="${{ secrets.DOCKER_PATH }}/nestjs-template:latest"
            
            echo "===== æ„å»ºDockeré•œåƒ ====="
            docker image prune -f
            
            if ! docker build \
              --build-arg NODE_ENV="${{ github.event.inputs.deploy_env || 'production' }}" \
              --build-arg BUILD_VERSION="$IMAGE_TAG" \
              --build-arg BUILD_COMMIT="${{ steps.build_info.outputs.commit_hash }}" \
              --cache-from $LATEST_IMAGE \
              -t $IMAGE_NAME \
              -t $LATEST_IMAGE .; then
              echo "Dockeræ„å»ºå¤±è´¥ï¼"
              exit 1
            fi
            
            echo "===== æ¨é€Dockeré•œåƒ ====="
            if ! docker push $IMAGE_NAME; then
              echo "Dockeræ¨é€å¤±è´¥ï¼"
              exit 1
            fi
            docker push $LATEST_IMAGE
            
            echo "===== æ›´æ–°docker-compose.yml ====="
            cp docker-compose.yml docker-compose.yml.bak
            sed -i.bak "s|image: chen-docker/nestjs-template.*|image: ${IMAGE_NAME}|" docker-compose.yml
            if ! grep -q "$IMAGE_NAME" docker-compose.yml; then
              echo "é”™è¯¯ï¼šdocker-compose.ymlé•œåƒæ ‡ç­¾æ›¿æ¢å¤±è´¥ï¼"
              cp docker-compose.yml.bak docker-compose.yml
              exit 1
            fi
            rm -f docker-compose.yml.bak
            echo "æ›¿æ¢åçš„é•œåƒé…ç½®ï¼š"
            cat docker-compose.yml | grep "image: "

      # æ ¸å¿ƒä¿®æ”¹ï¼šæ¸…ç†æ—§é•œåƒæ”¹ä¸ºä¿ç•™æœ€æ–°3ä¸ªç‰ˆæœ¬
      - name: Cleanup old Docker images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          timeout: ${{ env.SSH_TIMEOUT }}
          script: |
            set -e
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "===== æ¸…ç†æ—§é•œåƒï¼ˆä»…ä¿ç•™æœ€æ–°3ä¸ªç‰ˆæœ¬ï¼‰ ====="
            
            # æ­¥éª¤1ï¼šè·å–è¯¥é¡¹ç›®æ‰€æœ‰é•œåƒï¼ˆæ’é™¤latestæ ‡ç­¾ï¼‰ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åº
            # è¾“å‡ºæ ¼å¼ï¼šåˆ›å»ºæ—¶é—´æˆ³ é•œåƒå:æ ‡ç­¾
            IMAGES_LIST=$(docker images --format "{{.CreatedAt}}\t{{.Repository}}:{{.Tag}}" \
              | grep "${{ secrets.DOCKER_PATH }}/nestjs-template" \
              | grep -v "latest" \
              | awk '{
                  # å°†Dockerçš„CreatedAtæ ¼å¼ï¼ˆ2026-02-09T12:34:56.789Zï¼‰è½¬ä¸ºæ—¶é—´æˆ³
                  split($1, d, "-"); 
                  split(d[3], t, "T"); 
                  split(t[2], s, ":"); 
                  sub(/\..*/, "", s[3]); # å»æ‰æ¯«ç§’
                  ts = mktime(d[1]" "d[2]" "t[1]" "s[1]" "s[2]" "s[3]); 
                  print ts "\t" $2
                }' \
              | sort -nr) # æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            
            # æ­¥éª¤2ï¼šæå–é•œåƒååˆ—è¡¨ï¼ˆä»…ä¿ç•™åç§°ï¼Œå»æ‰æ—¶é—´æˆ³ï¼‰
            IMAGE_NAMES=$(echo "$IMAGES_LIST" | awk '{print $2}')
            
            # æ­¥éª¤3ï¼šç»Ÿè®¡é•œåƒæ€»æ•°
            TOTAL_IMAGES=$(echo "$IMAGE_NAMES" | wc -l | tr -d ' ')
            echo "è¯¥é¡¹ç›®é•œåƒæ€»æ•°ï¼š$TOTAL_IMAGES"
            
            # æ­¥éª¤4ï¼šå¦‚æœé•œåƒæ•°è¶…è¿‡3ä¸ªï¼Œåˆ é™¤ç¬¬4ä¸ªåŠä»¥åçš„æ—§é•œåƒ
            if [ "$TOTAL_IMAGES" -gt 3 ]; then
              echo "éœ€è¦æ¸…ç†çš„æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°3ä¸ªï¼‰ï¼š"
              # è·³è¿‡å‰3ä¸ªï¼Œåˆ—å‡ºè¦åˆ é™¤çš„é•œåƒ
              IMAGES_TO_DELETE=$(echo "$IMAGE_NAMES" | tail -n +4)
              
              # éå†åˆ é™¤æ—§é•œåƒ
              while IFS= read -r IMAGE; do
                if [ -n "$IMAGE" ]; then
                  echo "åˆ é™¤æ—§é•œåƒï¼š$IMAGE"
                  docker rmi -f "$IMAGE" || echo "é•œåƒ$IMAGEå·²è¢«ä½¿ç”¨ï¼Œè·³è¿‡æ¸…ç†"
                fi
              done <<< "$IMAGES_TO_DELETE"
            else
              echo "é•œåƒæ€»æ•°â‰¤3ä¸ªï¼Œæ— éœ€æ¸…ç†"
            fi
            
            # å…œåº•ï¼šæ¸…ç†Dockeræ‚¬ç©ºé•œåƒ/å®¹å™¨ï¼ˆå¸¸è§„è¿ç»´ï¼‰
            docker image prune -f
            docker container prune -f

      # æœ€ç»ˆç‰ˆï¼šåœæ—§å®¹å™¨ â†’ å¯æ–°å®¹å™¨ â†’ åˆ æ—§å®¹å™¨ å®Œæ•´é—­ç¯
      - name: Restart containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          timeout: ${{ env.SSH_TIMEOUT }}
          script: |
            set -e
            cd ${{ env.SERVER_PROJECT_DIR }}
            
            echo "===== æ­¥éª¤1ï¼šåœæ­¢å½“å‰é¡¹ç›®æ‰€æœ‰æ—§å®¹å™¨ï¼ˆé‡Šæ”¾ç«¯å£ï¼‰ ====="
            # ä»…åœæ­¢å®¹å™¨ï¼Œä¸åˆ é™¤ï¼ˆå…ˆé‡Šæ”¾ç«¯å£ï¼Œä¿è¯æ–°å®¹å™¨èƒ½å¯åŠ¨ï¼‰
            docker-compose stop || echo "å½“å‰æ— è¿è¡Œä¸­çš„å®¹å™¨"
            
            echo "===== æ­¥éª¤2ï¼šå¯åŠ¨æ–°å®¹å™¨ï¼ˆç«¯å£å·²é‡Šæ”¾ï¼Œæ— å†²çªï¼‰ ====="
            docker-compose up -d --build
            
            echo "===== æ­¥éª¤3ï¼šéªŒè¯æ–°å®¹å™¨å¯åŠ¨çŠ¶æ€ ====="
            sleep 3
            if ! docker-compose ps | grep -q "Up"; then
              echo "é”™è¯¯ï¼šæ–°å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"
              docker-compose logs
              exit 1
            fi
            
            echo "===== æ­¥éª¤4ï¼šå½»åº•åˆ é™¤æ—§å®¹å™¨ï¼ˆæ¸…ç†æ®‹ç•™èµ„æºï¼‰ ====="
            # åªåˆ é™¤å½“å‰é¡¹ç›®å·²åœæ­¢çš„æ—§å®¹å™¨ï¼ˆ-f å¼ºåˆ¶åˆ é™¤ï¼Œæ— éœ€ç¡®è®¤ï¼‰
            docker-compose rm -f || echo "æ— æ—§å®¹å™¨éœ€åˆ é™¤"
            
            # ä¼ä¸šçº§å…œåº•ï¼šæ¸…ç†Dockeræ‚¬ç©ºèµ„æºï¼ˆä¸å½±å“ä¸šåŠ¡ï¼Œå¸¸è§„è¿ç»´æ“ä½œï¼‰
            docker container prune -f > /dev/null 2>&1
            docker network prune -f > /dev/null 2>&1
            
            echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œæ—§å®¹å™¨å·²å½»åº•åˆ é™¤ï¼"

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          timeout: ${{ env.SSH_TIMEOUT }}
          script: |
            set -e
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "===== éƒ¨ç½²éªŒè¯ ====="
            echo "--- å®¹å™¨çŠ¶æ€ ---"
            docker-compose ps
            echo "--- NGINX æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰ ---"
            docker-compose logs --tail=20 nginx
            echo "--- åç«¯æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰ ---"
            docker-compose logs --tail=20 nestjs-backend
            
            sleep 10
            echo "--- æ¥å£ç‰ˆæœ¬æ£€æŸ¥ ---"
            HEALTH_CHECK_URL="https://nestjs.duguqinchen.com/proApi/"
            # æ ¸å¿ƒæ–°å¢ï¼šè®¿é—®æ¥å£å¹¶è¾“å‡ºå®Œæ•´å“åº”ç»“æœ
            echo "è®¿é—®æ¥å£: $HEALTH_CHECK_URL"
            # ä½¿ç”¨ curl è·å–å®Œæ•´å“åº”ï¼ˆåŒ…å«çŠ¶æ€ç +å“åº”ä½“ï¼‰ï¼Œå¹¶å¤„ç†å¼‚å¸¸
            RESPONSE_CONTENT=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$HEALTH_CHECK_URL")
            # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
            HTTP_STATUS=$(echo "$RESPONSE_CONTENT" | grep -oP 'HTTP_STATUS:\K\d+' | tail -1)
            RESPONSE_BODY=$(echo "$RESPONSE_CONTENT" | sed '$ d' | sed 's/HTTP_STATUS://g')
            
            # è¾“å‡ºå®Œæ•´å“åº”ç»“æœ
            echo "æ¥å£å“åº”çŠ¶æ€ç : $HTTP_STATUS"
            echo "æ¥å£å“åº”å†…å®¹: "
            echo "$RESPONSE_BODY" | jq . 2>/dev/null || echo "$RESPONSE_BODY" # å°è¯•æ ¼å¼åŒ–JSONï¼ŒéJSONåˆ™ç›´æ¥è¾“å‡º