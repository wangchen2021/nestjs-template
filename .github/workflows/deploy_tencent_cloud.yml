name: NestJS Backend Auto Deploy to Tencent Cloud (Docker)
run-name: ${{ github.actor }} Ê≠£Âú®ÈÄöËøáDockerÈÉ®ÁΩ≤NestJSÂêéÁ´Ø üöÄ

on:
  release:
    types: [published]

env:
  SERVER_PROJECT_DIR: "/usr/local/project/nestjs-template/pro"
  DOCKER_REGISTRY: "124.221.133.110:5000/nestjs-template"
  NGINX_CONF_DIR: "nginx/conf.d"

jobs:
  Deploy-to-Tencent-Cloud-Docker:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'pnpm'

      - name: Install dependencies & Build
        run: |
          pnpm install
          pnpm build
        env:
          NODE_ENV: production

      # Á°Æ‰øùÊúçÂä°Âô®ÁõÆÂΩïÂ≠òÂú®
      - name: Ensure server directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/${{ env.NGINX_CONF_DIR }}

      # ‰∏ä‰º†ÈÖçÁΩÆÊñá‰ª∂ÔºàÊó†ÂµåÂ•óË∑ØÂæÑÔºâ
      - name: Upload Docker & Nginx configs
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./Dockerfile,./docker-compose.yml,./${{ env.NGINX_CONF_DIR }}/default.conf"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # ‰∏ä‰º† dist + envÔºàÊó†ÂµåÂ•óË∑ØÂæÑÔºâ
      - name: Upload dist, package.json, env
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./dist,./package.json,./pnpm-lock.yaml,./src/config/env/.env,./src/config/env/.env.production"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # ÊûÑÂª∫ÈïúÂÉè + Êõ¥Êñ∞Ê†áÁ≠æ
      - name: Build, Tag, Push Docker Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            docker build -t ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }} .
            docker push ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}
            sed -i "s|124.221.133.110:5000/nestjs-template:.*|${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}|" docker-compose.yml

      # ÈáçÂêØÊúçÂä°
      - name: Restart containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            docker-compose down
            docker-compose up -d --build
            docker-compose ps

      # È™åËØÅÊó•Âøó
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "=== NGINX LOG ==="
            docker-compose logs --tail=10 nginx
            echo "=== BACKEND LOG ==="
            docker-compose logs --tail=10 nestjs-backend