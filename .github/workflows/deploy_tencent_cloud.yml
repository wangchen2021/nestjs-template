name: NestJS Backend Auto Deploy to Tencent Cloud (Docker)
run-name: ${{ github.actor }} æ­£åœ¨é€šè¿‡Dockeréƒ¨ç½²NestJSåç«¯ ğŸš€
on:
  # ä»…ç›‘å¬mainåˆ†æ”¯çš„Releaseå‘å¸ƒäº‹ä»¶
  release:
    types: [published]

# æ ¸å¿ƒï¼šç»Ÿä¸€é…ç½®é¡¹ç›®ç›®å½•å˜é‡ï¼ˆåªéœ€æ”¹è¿™é‡Œï¼ï¼‰
env:
  # æœåŠ¡å™¨ç«¯é¡¹ç›®æ ¹ç›®å½•ï¼ˆæ‰€æœ‰è·¯å¾„åŸºäºè¿™ä¸ªå˜é‡ï¼‰
  SERVER_PROJECT_DIR: "/usr/local/project/nestjs-template/pro"
  # Dockerç§æœ‰ä»“åº“åœ°å€+é•œåƒåå‰ç¼€ï¼ˆç»Ÿä¸€é…ç½®ï¼‰
  DOCKER_REGISTRY: "124.221.133.110:5000/nestjs-template"
  # Nginxé…ç½®å­ç›®å½•ï¼ˆè‹¥æœ‰å˜åŠ¨ä»…æ”¹è¿™é‡Œï¼‰
  NGINX_CONF_DIR: "nginx/conf.d"

jobs:
  Deploy-to-Tencent-Cloud-Docker:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ è¯¥ä»»åŠ¡ç”± ${{ github.event_name }} äº‹ä»¶è‡ªåŠ¨è§¦å‘."
      - run: echo "ğŸ§ å½“å‰è¿è¡Œåœ¨ GitHub æ‰˜ç®¡çš„ ${{ runner.os }} æœåŠ¡å™¨ä¸Š!"
      - run: echo "ğŸ” å½“å‰åˆ†æ”¯æ˜¯ ${{ github.ref }}ï¼Œä»“åº“åç§°æ˜¯ ${{ github.repository }}."

      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: Check out repository code
        uses: actions/checkout@v5
      - run: echo "ğŸ’¡ ${{ github.repository }} ä»“åº“å·²å…‹éš†åˆ°è¿è¡Œå™¨."

      # æ­¥éª¤2ï¼šå®‰è£…pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'
      - run: echo "ğŸ“¦ pnpmåŒ…ç®¡ç†å™¨å®‰è£…å®Œæˆ."

      # æ­¥éª¤3ï¼šå®‰è£…Node.jsç¯å¢ƒ
      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'pnpm'

      # æ­¥éª¤4ï¼šå®‰è£…ä¾èµ–+æ„å»ºé¡¹ç›®ï¼ˆç”Ÿæˆdistç›®å½•ï¼‰
      - name: Install Dependencies & Build Project
        run: |
          pnpm install
          pnpm build
        env:
          NODE_ENV: production
      - run: echo "ğŸ—ï¸ NestJSé¡¹ç›®æ„å»ºå®Œæˆï¼Œç”Ÿæˆdistç›®å½•."

      # æ­¥éª¤5ï¼šç™»å½•æœåŠ¡å™¨ç§æœ‰Dockerä»“åº“ï¼ˆå…³é”®ï¼æ¨é€é•œåƒç”¨ï¼‰
      - name: Login to Private Docker Registry
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}

      # æ­¥éª¤6ï¼šä¸Šä¼ Dockerç›¸å…³é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: Upload Docker Config Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "${{ github.workspace }}/Dockerfile,${{ github.workspace }}/docker-compose.yml,${{ github.workspace }}/${{ env.NGINX_CONF_DIR }}/default.conf"
          target: ${{ env.SERVER_PROJECT_DIR }}
          overwrite: true

      # æ­¥éª¤7ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆdistï¼‰åˆ°æœåŠ¡å™¨
      - name: Upload Build Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./dist/*,./package.json,./pnpm-lock.yaml"
          target: ${{ env.SERVER_PROJECT_DIR }}
          overwrite: true
          strip_components: 0

      # æ­¥éª¤8ï¼šæœåŠ¡å™¨ç«¯æ„å»ºDockeré•œåƒ+æ¨é€è‡³ç§æœ‰ä»“åº“
      - name: Build & Push Docker Image on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            # è¿›å…¥é¡¹ç›®ç›®å½•ï¼ˆä½¿ç”¨ç»Ÿä¸€å˜é‡ï¼‰
            cd ${{ env.SERVER_PROJECT_DIR }}
            
            # æ„å»ºé•œåƒï¼ˆä½¿ç”¨ç»Ÿä¸€çš„Dockerä»“åº“å˜é‡ï¼‰
            docker build -t ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }} .
            
            # æ¨é€é•œåƒåˆ°ç§æœ‰ä»“åº“
            docker push ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}
            
            # æ›´æ–°docker-compose.ymlä¸­çš„é•œåƒæ ‡ç­¾ï¼ˆé€‚é…Releaseç‰ˆæœ¬ï¼‰
            sed -i "s|image: ${{ env.DOCKER_REGISTRY }}:v1|image: ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}|g" docker-compose.yml

      # æ­¥éª¤9ï¼šæœåŠ¡å™¨ç«¯å¯åŠ¨/é‡å¯DockeræœåŠ¡
      - name: Start/Restart Docker Services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            
            # åœæ­¢æ—§æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            docker-compose down || echo "æ— æ—§æœåŠ¡éœ€åœæ­¢"
            
            # æ„å»º+å¯åŠ¨æ–°æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
            docker-compose up -d --build
            
            # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
            docker-compose ps

      # æ­¥éª¤10ï¼šéªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "ğŸ“Œ å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼š"
            cd ${{ env.SERVER_PROJECT_DIR }} && docker-compose ps
            
            # æ£€æŸ¥Nginxæ—¥å¿—ï¼ˆæ— æŠ¥é”™åˆ™æ­£å¸¸ï¼‰
            echo "ğŸ“Œ Nginxæœ€æ–°æ—¥å¿—ï¼š"
            cd ${{ env.SERVER_PROJECT_DIR }} && docker-compose logs --tail=10 nginx
            
            # æ£€æŸ¥NestJSæ—¥å¿—
            echo "ğŸ“Œ NestJSæœ€æ–°æ—¥å¿—ï¼š"
            cd ${{ env.SERVER_PROJECT_DIR }} && docker-compose logs --tail=10 nestjs-backend

      - run: echo "âœ… NestJSåç«¯å·²é€šè¿‡DockeræˆåŠŸéƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨ï¼ä»»åŠ¡çŠ¶æ€ï¼š${{ job.status }}."