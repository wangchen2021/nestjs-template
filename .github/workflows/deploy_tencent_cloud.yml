name: NestJS Backend Auto Deploy to Tencent Cloud (Docker)
run-name: ${{ github.actor }} æ­£åœ¨é€šè¿‡Dockeréƒ¨ç½²NestJSåç«¯ ğŸš€

on:
  release:
    types: [published]

env:
  SERVER_PROJECT_DIR: "/usr/local/project/nestjs-template/pro"
  DOCKER_REGISTRY: "124.221.133.110:5000/nestjs-template"
  NGINX_CONF_DIR: "nginx/conf.d"

jobs:
  Deploy-to-Tencent-Cloud-Docker:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'pnpm'

      - name: Install dependencies & Build
        run: |
          pnpm install
          pnpm build
          # éªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
          ls -la ./dist
          if [ ! -f "./dist/main.js" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
            exit 1
          fi
        env:
          NODE_ENV: production

      # ç¡®ä¿æœåŠ¡å™¨ç›®å½•å­˜åœ¨
      - name: Ensure server directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/${{ env.NGINX_CONF_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/src/config/env
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/dist  # ç¡®ä¿distç›®å½•å­˜åœ¨
            rm -rf ${{ env.SERVER_PROJECT_DIR }}/dist/* || echo "æ— æ—§distæ–‡ä»¶"

      # åˆå¹¶ä¸Šä¼ ï¼šé…ç½®æ–‡ä»¶ + package.json + envæ–‡ä»¶
      - name: Upload config & package files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./Dockerfile,./docker-compose.yml,./${{ env.NGINX_CONF_DIR }}/default.conf,./package.json,./pnpm-lock.yaml,./src/config/env/.env,./src/config/env/.env.production"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # ä¿®å¤ï¼šæ­£ç¡®ä¸Šä¼ distç›®å½•åˆ°æœåŠ¡å™¨çš„distç›®å½•ä¸‹
      - name: Upload dist directory
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./dist"  # ä¸Šä¼ æ•´ä¸ªdistç›®å½•
          target: ${{ env.SERVER_PROJECT_DIR }}  # ç›®æ ‡ç›®å½•
          strip_components: 0
          overwrite: true

      # éªŒè¯æœåŠ¡å™¨distæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Verify dist file on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            ls -la ./dist
            if [ ! -f "./dist/main.js" ]; then
              echo "ä¸Šä¼ å¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
              exit 1
            fi

      # ä¿®å¤ï¼šDockeræ„å»º+æ ‡ç­¾æ›´æ–°ï¼ˆå¢åŠ å®¹é”™+å…¼å®¹Linux sedï¼‰
      - name: Build, Tag, Push Docker Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            # æ„å»ºé•œåƒï¼ˆå¤±è´¥åˆ™é€€å‡ºï¼‰
            if ! docker build -t ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }} .; then
              echo "Dockeræ„å»ºå¤±è´¥ï¼"
              exit 1
            fi
            # æ¨é€é•œåƒï¼ˆå¤±è´¥åˆ™é€€å‡ºï¼‰
            if ! docker push ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}; then
              echo "Dockeræ¨é€å¤±è´¥ï¼"
              exit 1
            fi
            # ä¿®å¤sedå‘½ä»¤ï¼šå…¼å®¹Linuxï¼Œä¸”ä½¿ç”¨ç¯å¢ƒå˜é‡åŒ¹é…
            sed -i.bak "s|${{ env.DOCKER_REGISTRY }}:.*|${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}|" docker-compose.yml
            # åˆ é™¤sedç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶
            rm -f docker-compose.yml.bak

      # é‡å¯æœåŠ¡
      - name: Restart containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            docker-compose down || echo "å®¹å™¨æœªè¿è¡Œ"
            docker-compose up -d --build
            docker-compose ps

      # ä¿®å¤ï¼šéªŒè¯æ—¥å¿—ï¼ˆç§»é™¤å¤šä½™ä¸­æ–‡æ³¨é‡Šï¼‰
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "=== NGINX LOG ==="
            docker-compose logs --tail=10 nginx
            echo "=== BACKEND LOG ==="
            docker-compose logs --tail=10 nestjs-backend