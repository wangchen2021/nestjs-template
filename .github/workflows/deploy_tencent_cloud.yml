name: NestJS Backend Auto Deploy to Tencent Cloud (BtPanel)
run-name: ${{ github.actor }} æ­£åœ¨é€šè¿‡å®å¡”éƒ¨ç½² NestJS åç«¯ ğŸš€
on:
  # æ ¸å¿ƒï¼šä»…ç›‘å¬ main åˆ†æ”¯çš„ Release å‘å¸ƒäº‹ä»¶
  release:
    types: [published] # ä»…å½“ Release è¢«ã€Œå‘å¸ƒã€ï¼ˆè€Œéè‰ç¨¿/åˆ é™¤ï¼‰æ—¶è§¦å‘

jobs:
  Deploy-to-Tencent-Cloud-Bt:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ è¯¥ä»»åŠ¡ç”± ${{ github.event_name }} äº‹ä»¶è‡ªåŠ¨è§¦å‘."
      - run: echo "ğŸ§ å½“å‰è¿è¡Œåœ¨ GitHub æ‰˜ç®¡çš„ ${{ runner.os }} æœåŠ¡å™¨ä¸Š!"
      - run: echo "ğŸ” å½“å‰åˆ†æ”¯æ˜¯ ${{ github.ref }}ï¼Œä»“åº“åç§°æ˜¯ ${{ github.repository }}."

      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: Check out repository code
        uses: actions/checkout@v5
      - run: echo "ğŸ’¡ ${{ github.repository }} ä»“åº“å·²å…‹éš†åˆ°è¿è¡Œå™¨."

      # æ­¥éª¤2ï¼šå®‰è£… pnpmï¼ˆGitHub è¿è¡Œå™¨é»˜è®¤æ—  pnpmï¼Œéœ€æ‰‹åŠ¨å®‰è£…ï¼‰
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'
      - run: echo "ğŸ“¦ pnpm åŒ…ç®¡ç†å™¨å®‰è£…å®Œæˆ."

      # æ­¥éª¤3ï¼šå®‰è£… Node.js ç¯å¢ƒ
      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'pnpm'

      # æ­¥éª¤4ï¼šç”¨ pnpm å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install Project Dependencies
        run: pnpm install
      - run: echo "ğŸ–¥ï¸ é¡¹ç›®ä¾èµ–å®‰è£…å®Œæˆï¼Œå‡†å¤‡æ„å»º."

      # æ­¥éª¤5ï¼šæ„å»º NestJS é¡¹ç›®
      - name: Build NestJS Project
        run: pnpm build
        env:
          NODE_ENV: production
          # åç«¯ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ˆæ ¹æ®å®é™…éœ€è¦æ·»åŠ ï¼‰
          # DATABASE_URL: ${{ secrets.DATABASE_URL }}
      - run: echo "ğŸ—ï¸ NestJS é¡¹ç›®æ„å»ºå®Œæˆï¼Œç”Ÿæˆ dist ç›®å½•."

      # æ­¥éª¤6ï¼šæŸ¥çœ‹æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰
      - name: List Build Files
        run: ls -la ${{ github.workspace }}/dist
      - run: echo "ğŸ“‚ å·²éªŒè¯ dist ç›®å½•ç»“æ„."

      # æ­¥éª¤7ï¼šåˆ›å»ºéƒ¨ç½²ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      - name: Create Deployment Directory on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }} # è…¾è®¯äº‘æœåŠ¡å™¨å…¬ç½‘IP
          username: ${{ secrets.TENCENT_SERVER_USER }} # æœåŠ¡å™¨ç™»å½•è´¦å·ï¼ˆå¦‚ rootï¼‰
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }} # SSH ç§é’¥
          port: ${{ secrets.TENCENT_SERVER_PORT }} # SSH ç«¯å£
          script: mkdir -p /usr/local/project/nestjs-template/pro # åˆ›å»ºåç«¯éƒ¨ç½²ç›®å½•

      # æ­¥éª¤8ï¼šä¸Šä¼  dist ç›®å½•åˆ°å®å¡”æœåŠ¡å™¨ï¼ˆåç«¯éƒ¨ç½²ç›®å½•ï¼‰
      - name: Upload Build Files to Tencent Cloud (BtPanel)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }} # è…¾è®¯äº‘æœåŠ¡å™¨å…¬ç½‘IP
          username: ${{ secrets.TENCENT_SERVER_USER }} # æœåŠ¡å™¨ç™»å½•è´¦å·ï¼ˆå¦‚ rootï¼‰
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }} # SSH ç§é’¥
          port: ${{ secrets.TENCENT_SERVER_PORT }} # SSH ç«¯å£
          source: "${{ github.workspace }}/dist/*,${{ github.workspace }}/package.json,${{ github.workspace }}/pnpm-lock.yaml"
          target: "/usr/local/project/nestjs-template/pro"
          overwrite: true # è¦†ç›–åŸæœ‰æ–‡ä»¶

      # æ­¥éª¤9ï¼šåœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–å¹¶é‡å¯åº”ç”¨
      - name: Install Dependencies and Restart Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
            cd /usr/local/project/nestjs-template/pro
            
            # å®‰è£…ç”Ÿäº§ä¾èµ–
            pnpm install --prod
            
            # é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
            # echo "PORT=3000" > .env
            # echo "NODE_ENV=production" >> .env
            
            # ä½¿ç”¨ PM2 é‡å¯åº”ç”¨ï¼ˆå‡è®¾å·²å®‰è£… PM2ï¼‰
            if command -v pm2 &> /dev/null; then
              pm2 restart version_api || pm2 start dist/main.js --name version_api
              echo "âœ… åº”ç”¨å·²é€šè¿‡ PM2 é‡å¯"
            else
              echo "âŒ PM2 æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… PM2: npm install -g pm2"
              exit 1
            fi

      # æ­¥éª¤10ï¼šéªŒè¯éƒ¨ç½²çŠ¶æ€
      - name: Verify Deployment Status
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
            pm2 status version_api
            echo "âœ… éƒ¨ç½²ä»»åŠ¡å·²å®Œæˆï¼åº”ç”¨çŠ¶æ€ï¼š$?"

      - run: echo "âœ… NestJS åç«¯é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°è…¾è®¯å®å¡”æœåŠ¡å™¨ï¼ä»»åŠ¡çŠ¶æ€ï¼š${{ job.status }}."