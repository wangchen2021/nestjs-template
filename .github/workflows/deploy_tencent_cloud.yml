name: NestJS Backend Auto Deploy to Tencent Cloud (Docker)
run-name: ${{ github.actor }} æ­£åœ¨é€šè¿‡Dockeréƒ¨ç½²NestJSåç«¯ ğŸš€

on:
  release:
    types: [published]

env:
  SERVER_PROJECT_DIR: "/usr/local/project/nestjs-template/pro"
  DOCKER_REGISTRY: "124.221.133.110:5000/nestjs-template"
  NGINX_CONF_DIR: "nginx/conf.d"

jobs:
  Deploy-to-Tencent-Cloud-Docker:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # å¿…é¡»æ‹‰å–å®Œæ•´Gitå†å²

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'pnpm'

      # ========== ä¿®å¤ï¼šç”Ÿæˆbuild-info.json + æ˜¾å¼è¾“å‡ºå˜é‡ ==========
      - name: Generate build info file
        id: build_info # å¿…é¡»ä¿ç•™idï¼Œç”¨äºåç»­å¼•ç”¨è¾“å‡ºå˜é‡
        run: |
          # åˆå§‹åŒ–é»˜è®¤å€¼ï¼Œé˜²æ­¢å˜é‡ä¸ºç©º
          CORE_VERSION="unknown"
          FULL_VERSION="unknown-prod+unknown.unknown"
          COMMIT_HASH="unknown"
          BUILD_TIME="unknown"

          # 1. è·å–Git CommitçŸ­å“ˆå¸Œï¼ˆä¿åº•ï¼‰
          if command -v git &> /dev/null; then
            COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            BUILD_TIME=$(TZ=Asia/Shanghai date +%Y%m%d.%H%M%S 2>/dev/null || echo "unknown")
            
            # 2. è·å–æ ¸å¿ƒç‰ˆæœ¬ï¼ˆä¼˜å…ˆRelease Tagï¼‰
            if [ -n "${{ github.ref_name }}" ]; then
              CORE_VERSION="${{ github.ref_name }}"
            else
              # å°è¯•è·å–æœ€æ–°Tag
              TAG_VERSION=$(git describe --tags --abbrev=0 2>/dev/null)
              if [ -n "$TAG_VERSION" ]; then
                CORE_VERSION="$TAG_VERSION"
              else
                CORE_VERSION="$COMMIT_HASH" # ç”¨Commitå“ˆå¸Œå…œåº•
              fi
            fi
            
            # 3. æ‹¼æ¥å®Œæ•´ç‰ˆæœ¬å·
            FULL_VERSION="${CORE_VERSION}-prod+${BUILD_TIME}.${COMMIT_HASH}"
          fi
          
          # 4. åˆ›å»ºç›®å½• + ç”Ÿæˆbuild-info.json
          mkdir -p ./src/config
          cat > ./src/config/build-info.json << EOF
          {
            "coreVersion": "${CORE_VERSION}",
            "env": "prod",
            "commitHash": "${COMMIT_HASH}",
            "buildTime": "${BUILD_TIME}",
            "fullVersion": "${FULL_VERSION}",
            "buildId": "${{ github.run_id }}-${{ github.run_attempt }}"
          }
          EOF
          
          # 5. æ–¹å¼1ï¼šè¾“å‡ºåˆ°stepçš„outputsï¼ˆæ¨èï¼Œä¼˜å…ˆçº§é«˜äºenvï¼‰
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "core_version=${CORE_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          
          # 6. æ–¹å¼2ï¼šè¾“å‡ºåˆ°ç¯å¢ƒå˜é‡ï¼ˆå…¼å®¹åŸæœ‰å¼•ç”¨ï¼‰
          echo "FULL_VERSION=${FULL_VERSION}" >> $GITHUB_ENV
          echo "CORE_VERSION=${CORE_VERSION}" >> $GITHUB_ENV
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          
          # éªŒè¯è¾“å‡º
          echo "æœ€ç»ˆç‰ˆæœ¬ä¿¡æ¯ï¼šFULL_VERSION=$FULL_VERSION, CORE_VERSION=$CORE_VERSION"
          cat ./src/config/build-info.json
        env:
          NODE_ENV: production

      - name: Install dependencies & Build
        run: |
          pnpm install
          pnpm build
          # éªŒè¯æ„å»ºäº§ç‰©
          ls -la ./dist
          if [ ! -f "./dist/main.js" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
            exit 1
          fi
          # éªŒè¯ç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f "./dist/config/build-info.json" ]; then
            echo "è­¦å‘Šï¼šbuild-info.jsonæœªæ‰“åŒ…åˆ°distï¼Œè¯·æ£€æŸ¥nest-clié…ç½®ï¼"
          fi
        env:
          NODE_ENV: production

      # ç¡®ä¿æœåŠ¡å™¨ç›®å½•å­˜åœ¨
      - name: Ensure server directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/${{ env.NGINX_CONF_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/src/config/env
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/src/config
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/dist
            rm -rf ${{ env.SERVER_PROJECT_DIR }}/dist/* || echo "æ— æ—§distæ–‡ä»¶"

      # ä¸Šä¼ é…ç½®æ–‡ä»¶ï¼ˆå«ç‰ˆæœ¬æ–‡ä»¶ï¼‰
      - name: Upload config & package files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./Dockerfile,./docker-compose.yml,./${{ env.NGINX_CONF_DIR }}/default.conf,./package.json,./pnpm-lock.yaml,./src/config/env/.env,./src/config/env/.env.production,./src/config/build-info.json"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # ä¸Šä¼ distç›®å½•
      - name: Upload dist directory
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./dist"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # éªŒè¯æœåŠ¡å™¨æ–‡ä»¶
      - name: Verify dist file on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            ls -la ./dist
            if [ ! -f "./src/config/build-info.json" ]; then
              echo "è­¦å‘Šï¼šsrc/config/build-info.jsonæœªä¸Šä¼ ï¼"
            fi
            if [ ! -f "./dist/config/build-info.json" ]; then
              echo "è­¦å‘Šï¼šdist/config/build-info.jsonæœªä¸Šä¼ ï¼"
            fi
            if [ ! -f "./dist/main.js" ]; then
              echo "ä¸Šä¼ å¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
              exit 1
            fi

      # æ„å»ºDockeré•œåƒï¼ˆä½¿ç”¨step outputsï¼Œå½»åº•æ¶ˆé™¤è­¦å‘Šï¼‰
      - name: Build, Tag, Push Docker Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            IMAGE_TAG="${{ steps.build_info.outputs.full_version }}"
            # æ„å»ºé•œåƒï¼ˆæ·»åŠ å®¹é”™ï¼‰
            if ! docker build \
              --build-arg BUILD_VERSION="${{ steps.build_info.outputs.full_version }}" \
              --build-arg BUILD_COMMIT="${{ steps.build_info.outputs.commit_hash }}" \
              -t ${{ env.DOCKER_REGISTRY }}:$IMAGE_TAG .; then
              echo "Dockeræ„å»ºå¤±è´¥ï¼"
              exit 1
            fi
            # æ¨é€é•œåƒ
            if ! docker push ${{ env.DOCKER_REGISTRY }}:$IMAGE_TAG; then
              echo "Dockeræ¨é€å¤±è´¥ï¼"
              exit 1
            fi
            # æ›´æ–°docker-compose.yml
            sed -i.bak "s|${{ env.DOCKER_REGISTRY }}:.*|${{ env.DOCKER_REGISTRY }}:$IMAGE_TAG|" docker-compose.yml
            rm -f docker-compose.yml.bak

      # é‡å¯æœåŠ¡
      - name: Restart containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            docker-compose down || echo "å®¹å™¨æœªè¿è¡Œ"
            docker-compose up -d --build
            docker-compose ps

      # éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "=== NGINX LOG ==="
            docker-compose logs --tail=10 nginx
            echo "=== BACKEND LOG ==="
            docker-compose logs --tail=10 nestjs-backend
            sleep 5
            echo "=== éªŒè¯ç‰ˆæœ¬ä¿¡æ¯æ¥å£ ==="
            curl -s http://localhost:3000/info || echo "ç‰ˆæœ¬æ¥å£è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¥å£"