name: NestJS Backend Auto Deploy to Tencent Cloud (Docker)
run-name: ${{ github.actor }} æ­£åœ¨é€šè¿‡Dockeréƒ¨ç½²NestJSåç«¯ ğŸš€

on:
  release:
    types: [published]

env:
  SERVER_PROJECT_DIR: "/usr/local/project/nestjs-template/pro"
  DOCKER_REGISTRY: "124.221.133.110:5000/nestjs-template"
  NGINX_CONF_DIR: "nginx/conf.d"

jobs:
  Deploy-to-Tencent-Cloud-Docker:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '10.20.0'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'pnpm'

      - name: Install dependencies & Build
        run: |
          pnpm install
          pnpm build
          # æ–°å¢ï¼šéªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨ï¼ˆå…³é”®ï¼ï¼‰
          ls -la ./dist
          if [ ! -f "./dist/main.js" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
            exit 1
          fi
        env:
          NODE_ENV: production

      # ç¡®ä¿æœåŠ¡å™¨ç›®å½•å­˜åœ¨ï¼ˆç§»é™¤rm -rf *ï¼Œé¿å…è¯¯åˆ ï¼‰
      - name: Ensure server directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/${{ env.NGINX_CONF_DIR }}
            mkdir -p ${{ env.SERVER_PROJECT_DIR }}/src/config/env
            # åªåˆ é™¤æ—§çš„distç›®å½•ï¼Œä¿ç•™å…¶ä»–é…ç½®
            rm -rf ${{ env.SERVER_PROJECT_DIR }}/dist || echo "æ— æ—§distç›®å½•"

      # ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: Upload Docker & Nginx configs
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./Dockerfile,./docker-compose.yml,./${{ env.NGINX_CONF_DIR }}/default.conf"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # å•ç‹¬ä¸Šä¼ distç›®å½•ï¼ˆé¿å…å’Œå…¶ä»–æ–‡ä»¶æ··ä¼ å¯¼è‡´ä¸¢å¤±ï¼‰
      - name: Upload dist directory
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./dist/*" # ä¸Šä¼ distä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œè€Œéç›®å½•æœ¬èº«
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # ä¸Šä¼ package.jsonã€pnpm-lock.yamlå’Œenvæ–‡ä»¶
      - name: Upload package.json & env files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          source: "./package.json,./pnpm-lock.yaml,./src/config/env/.env,./src/config/env/.env.production"
          target: ${{ env.SERVER_PROJECT_DIR }}
          strip_components: 0
          overwrite: true

      # éªŒè¯æœåŠ¡å™¨distæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Verify dist file on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            ls -la ./dist
            if [ ! -f "./dist/main.js" ]; then
              echo "ä¸Šä¼ å¤±è´¥ï¼šdist/main.jsä¸å­˜åœ¨ï¼"
              exit 1
            fi

      # æ„å»ºé•œåƒ + æ›´æ–°æ ‡ç­¾
      - name: Build, Tag, Push Docker Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            docker build -t ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }} .
            docker push ${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}
            sed -i "s|124.221.133.110:5000/nestjs-template:.*|${{ env.DOCKER_REGISTRY }}:${{ github.ref_name }}|" docker-compose.yml

      # é‡å¯æœåŠ¡
      - name: Restart containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            docker-compose down
            docker-compose up -d --build
            docker-compose ps

      # éªŒè¯æ—¥å¿—
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TENCENT_SERVER_HOST }}
          username: ${{ secrets.TENCENT_SERVER_USER }}
          key: ${{ secrets.TENCENT_SERVER_SSH_KEY }}
          port: ${{ secrets.TENCENT_SERVER_PORT }}
          script: |
            cd ${{ env.SERVER_PROJECT_DIR }}
            echo "=== NGINX LOG ==="
            docker-compose logs --tail=10 nginx
            echo "=== BACKEND LOG ==="
            docker-compose logs --tail=10 nestjs-backend